name: Deploy openclaw-container (Worker)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Show context
        run: |
          set -euxo pipefail
          echo "WORKFLOW=${GITHUB_WORKFLOW}"
          echo "JOB=${GITHUB_JOB}"
          echo "REF=${GITHUB_REF}"
          echo "SHA=${GITHUB_SHA}"
          node -v || true
          npm -v || true
          python3 --version || true

      - name: Checkout
        uses: actions/checkout@v4

      - name: List repo (debug)
        run: |
          set -euxo pipefail
          ls -la
          echo "---- openclaw-container ----"
          ls -la openclaw-container || true
          echo "---- openclaw-container/src ----"
          ls -la openclaw-container/src || true
          echo "---- wrangler files ----"
          find openclaw-container -maxdepth 2 -type f -iname "wrangler.*" -print || true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        working-directory: openclaw-container
        run: |
          set -euxo pipefail
          npm install
          npm ls --depth=0 || true

      - name: Typecheck
        working-directory: openclaw-container
        run: |
          set -euxo pipefail
          npm run typecheck --if-present

      - name: Wrangler version (debug)
        run: |
          set -euxo pipefail
          npx wrangler@4.63.0 --version

      - name: Deploy (wrangler) (FULL LOG)
        working-directory: openclaw-container
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_WEBHOOK_SECRET: ${{ secrets.TELEGRAM_WEBHOOK_SECRET }}
          WRANGLER_LOG: debug
        run: |
          set -euxo pipefail
          echo "=== Sanity check secrets (length only) ==="
          echo "CLOUDFLARE_API_TOKEN length: ${#CLOUDFLARE_API_TOKEN}"
          echo "CLOUDFLARE_ACCOUNT_ID length: ${#CLOUDFLARE_ACCOUNT_ID}"
          echo "TELEGRAM_BOT_TOKEN length: ${#TELEGRAM_BOT_TOKEN}"
          echo "GEMINI_API_KEY length: ${#GEMINI_API_KEY}"
          echo "=== Wrangler deploy ==="
          npx wrangler@4.63.0 deploy

      - name: Set Telegram Webhook (manual URL)
        if: ${{ always() }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          set -euxo pipefail
          echo "If deploy succeeded, set webhook manually to:"
          echo "https://<your-worker>.workers.dev/telegram/webhook"
          echo "Webhook info:"
          curl -sS "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getWebhookInfo" | cat
