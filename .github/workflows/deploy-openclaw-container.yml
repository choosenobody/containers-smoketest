name: Deploy openclaw-container (Worker)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Show context
        run: |
          echo "WORKFLOW=${GITHUB_WORKFLOW}"
          echo "JOB=${GITHUB_JOB}"
          echo "REF=${GITHUB_REF}"
          echo "SHA=${GITHUB_SHA}"

      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        working-directory: openclaw-container
        run: npm install

      - name: Typecheck
        working-directory: openclaw-container
        run: npm run typecheck

      - name: Deploy (wrangler)
        working-directory: openclaw-container
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # App secrets
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_WEBHOOK_SECRET: ${{ secrets.TELEGRAM_WEBHOOK_SECRET }}
          WRANGLER_LOG: debug
        run: |
          npx wrangler@4.63.0 deploy --json | tee deploy.json

      - name: Set Telegram Webhook (auto)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_WEBHOOK_SECRET: ${{ secrets.TELEGRAM_WEBHOOK_SECRET }}
        run: |
          URL=$(cat openclaw-container/deploy.json | python -c "import json,sys; d=json.load(sys.stdin); print(d.get('url') or d.get('deployment_url') or '')")
          echo "Deployed URL: $URL"
          if [ -z "$URL" ]; then
            echo "Cannot find deploy URL from wrangler output. Please set webhook manually."
            exit 0
          fi
          HOOK="${URL%/}$(python -c "import tomllib,sys; import pathlib; p=pathlib.Path('openclaw-container/wrangler.toml').read_text(); print('/telegram/webhook')")"
          echo "Setting webhook to: $HOOK"
          if [ -n "$TELEGRAM_WEBHOOK_SECRET" ]; then
            curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/setWebhook"               -H "content-type: application/json"               -d "{"url":"$HOOK","secret_token":"$TELEGRAM_WEBHOOK_SECRET"}" | cat
          else
            curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/setWebhook"               -H "content-type: application/json"               -d "{"url":"$HOOK"}" | cat
          fi
