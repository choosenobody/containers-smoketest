name: Deploy openclaw-container (Worker)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Show context
        run: |
          echo "WORKFLOW=${GITHUB_WORKFLOW}"
          echo "JOB=${GITHUB_JOB}"
          echo "REF=${GITHUB_REF}"
          echo "SHA=${GITHUB_SHA}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # NOTE:
      # npm ci 会要求 package-lock.json 与 package.json 完全一致。
      # 你当前 repo 的 openclaw-container 锁文件不同步，会导致 npm ci 直接失败。
      # 先用 npm install 跑通；等你修复 lockfile 后再改回 npm ci。
      - name: Install deps
        working-directory: openclaw-container
        run: npm install

      - name: Typecheck
        working-directory: openclaw-container
        run: npm run typecheck --if-present

      - name: Deploy (wrangler) and capture URL
        working-directory: openclaw-container
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_WEBHOOK_SECRET: ${{ secrets.TELEGRAM_WEBHOOK_SECRET }}
          WRANGLER_LOG: debug
        run: |
          set -euo pipefail
          echo "Deploying worker..."
          DEPLOY_OUTPUT="$(npx wrangler@4.63.0 deploy 2>&1)"
          echo "$DEPLOY_OUTPUT"

          # Extract the workers.dev URL from wrangler output
          DEPLOY_URL="$(echo "$DEPLOY_OUTPUT" | grep -Eo 'https://[a-zA-Z0-9.-]+\.workers\.dev' | head -n1 || true)"
          if [ -z "$DEPLOY_URL" ]; then
            echo "❌ Cannot find deployment URL from wrangler output."
            echo "Tip: ensure wrangler printed a workers.dev URL, or update the grep pattern."
            exit 1
          fi

          echo "✅ DEPLOY_URL=$DEPLOY_URL"
          echo "DEPLOY_URL=$DEPLOY_URL" >> "$GITHUB_ENV"

      - name: Set Telegram Webhook (auto)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_WEBHOOK_SECRET: ${{ secrets.TELEGRAM_WEBHOOK_SECRET }}
        run: |
          set -euo pipefail
          if [ -z "${DEPLOY_URL:-}" ]; then
            echo "❌ DEPLOY_URL is empty; previous step failed to capture URL."
            exit 1
          fi

          HOOK="${DEPLOY_URL%/}/telegram/webhook"
          echo "Setting Telegram webhook to: $HOOK"

          if [ -n "${TELEGRAM_WEBHOOK_SECRET:-}" ]; then
            curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/setWebhook"               -H "content-type: application/json"               -d "{"url":"$HOOK","secret_token":"$TELEGRAM_WEBHOOK_SECRET"}" | cat
          else
            curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/setWebhook"               -H "content-type: application/json"               -d "{"url":"$HOOK"}" | cat
          fi

      - name: Show webhook info (debug)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          set -euo pipefail
          echo "Webhook info:"
          curl -sS "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getWebhookInfo" | cat
